name: TestHarness (Windows)

# Triggered automatically on the last day of each month
# Also supports manual execution via GitHub UI
on:
  schedule:
    # Run at 1:00 AM UTC on the 31st of months with 31 days (Jan, Mar, May, Jul, Aug, Oct, Dec)
    - cron: '0 1 31 1,3,5,7,8,10,12 *'
    # Run at 1:00 AM UTC on the 30th of months with 30 days (Apr, Jun, Sep, Nov)
    - cron: '0 1 30 4,6,9,11 *'
    # Run at 1:00 AM UTC on the 29th of February (leap years)
    - cron: '0 1 29 2 *'
    # Run at 1:00 AM UTC on the 28th of February (non-leap years)
    - cron: '0 1 28 2 *'
  workflow_dispatch:

jobs:
  build:
    runs-on: windows-latest
    timeout-minutes: 15

    steps:
      # Step 1: Checkout develop branch
      - name: Checkout develop branch
        uses: actions/checkout@v5
        with:
          ref: develop

      # Step 2: Setup Python 3.13 environment for test execution
      - name: Setup Python
        uses: actions/setup-python@v6
        with:
          python-version: '3.13'

      # Step 3: Install Python dependencies from setups/requirements.txt
      - name: Install Python Dependencies
        run: |
          python -m pip install --upgrade pip > $null 2>&1
          pip install --quiet -r setups/requirements.txt > $null 2>&1
        shell: pwsh

      # Step 4: Setup Ruby and Install Gems
      - name: Setup Ruby and Install Gems
        run: |
          # Install Ruby with DevKit support
          choco install ruby --no-progress -y > $null 2>&1
          refreshenv

          # Install MSYS2 toolchain required for native extensions
          ridk install 3 > $null 2>&1

          # Install Bundler and project gems quietly
          gem install bundler --quiet > $null 2>&1
          bundle config set --local path vendor/bundle
          bundle install --quiet > $null 2>&1
        shell: pwsh

      # Step 5: Start Jekyll server and execute automated test suite
      - name: Start Jekyll Server and Run Tests
        run: |
          # Launch Jekyll server in background
          Start-Process -NoNewWindow -FilePath "bundle" -ArgumentList "exec", "jekyll", "serve"
          Start-Sleep -Seconds 5

          # Wait for server to become available
          $maxAttempts = 60
          for ($i = 1; $i -le $maxAttempts; $i++) {
            try {
              Invoke-WebRequest -Uri http://localhost:4000 -UseBasicParsing | Out-Null
              Write-Host "Jekyll server is up!"
              break
            } catch {
              Write-Host "Waiting for server... ($i)"
              Start-Sleep -Seconds 1
            }
          }

          # Final check before running tests
          try {
            Invoke-WebRequest -Uri http://localhost:4000 -UseBasicParsing | Out-Null
          } catch {
            Write-Error "Server failed to start within timeout. Aborting tests."
            exit 1
          }
          
          # Execute Python test suite
          python tests/run.py
        shell: pwsh