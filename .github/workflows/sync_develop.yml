name: Sync Develop After Squash Merge

# Trigger this workflow when a pull request to 'main' is closed
on:
  pull_request:
    types: [closed]
    branches:
      - main

jobs:
  sync-develop:
    # Only run if:
    # - The PR was merged
    # - The source branch was 'develop'
    # - The PR was created by shubhamrdarda
    if: github.event.pull_request.merged == true &&
        github.event.pull_request.head.ref == 'develop' &&
        github.event.pull_request.user.login == 'shubhamrdarda'
    runs-on: ubuntu-latest

    steps:
      # Step 1: Checkout the latest 'main' branch with full history
      - name: Checkout main branch
        uses: actions/checkout@v5
        with:
          ref: main
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      # Step 2: Configure Git identity
      - name: Configure Git
        run: |
          git config user.name "GoDarda Bot"
          git config user.email "bot@godarda.dev"

      # Step 3: Fetch all branches
      - name: Fetch all branches
        run: git fetch --all

      # Step 4: Confirm squash commit landed on main
      - name: Wait for squash commit to appear
        id: wait_for_commit
        run: |
          EXPECTED_COMMIT="${{ github.event.pull_request.merge_commit_sha }}"
          echo "Expected squash commit: $EXPECTED_COMMIT"

          for i in {1..5}; do
            git fetch origin main
            ACTUAL_COMMIT=$(git rev-parse origin/main)
            echo "Attempt $i: main is at $ACTUAL_COMMIT"

            if [ "$ACTUAL_COMMIT" = "$EXPECTED_COMMIT" ]; then
              echo "Squash commit confirmed on main."
              echo "commit_ready=true" >> $GITHUB_OUTPUT
              break
            fi

            echo "Waiting for GitHub to sync..."
            sleep 30
          done

      # Step 5: Force-push main into develop
      - name: Sync develop from main
        run: |
          git push origin main:develop --force

      # Step 6: Log confirmation message
      - name: Log sync message
        run: |
          echo "'develop' has been synced from 'main'."
          echo "Note: squash commit confirmation status: ${{ steps.wait_for_commit.outputs.commit_ready || 'not confirmed' }}"