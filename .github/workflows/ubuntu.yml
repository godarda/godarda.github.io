name: TestHarness (Ubuntu)

# Triggered on every push to the develop branch
# Triggered automatically on the 15th of every month at 11:30 UTC
# Also supports manual execution via GitHub UI
on:
  push:
    branches:
      - develop
  schedule:
    # Run on the 31st of months with 31 days (Jan, Mar, May, Jul, Aug, Oct, Dec)
    - cron: '0 0 31 1,3,5,7,8,10,12 *'
    # Run on the 30th of months with 30 days (Apr, Jun, Sep, Nov)
    - cron: '0 0 30 4,6,9,11 *'
    # Run on the 29th of February (leap years)
    - cron: '0 0 29 2 *'
    # Run on the 28th of February (non-leap years)
    - cron: '0 0 28 2 *'
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      # Step 1: Checkout the latest commit from the repository
      - name: Checkout Code
        uses: actions/checkout@v5

      # Step 2: Setup Python 3.13 environment for test execution
      - name: Setup Python
        uses: actions/setup-python@v6
        with:
          python-version: '3.13'

      # Step 3: Install Python dependencies from setups/requirements.txt
      - name: Install Python Dependencies
        run: |
          python3 -m pip install --upgrade pip
          pip install -r setups/requirements.txt
        shell: bash

      # Step 4: Setup Oracle Java 21 for JVM-based tooling
      - name: Setup Java
        uses: actions/setup-java@v5
        with:
          distribution: 'oracle'
          java-version: '21'

      # Step 5: Install Rust, FreeGLUT, and NASM
      - name: Install Rust, FreeGLUT, and NASM
        run: |
          sudo apt-get update
          sudo apt-get install -y rustc freeglut3-dev nasm
        shell: bash

      # Step 6: Install Google Chrome browser
      - name: Install Google Chrome
        run: |
          wget -q -O - https://dl.google.com/linux/linux_signing_key.pub | sudo apt-key add -
          sudo sh -c 'echo "deb [arch=amd64] http://dl.google.com/linux/chrome/deb/ stable main" >> /etc/apt/sources.list.d/google-chrome.list'
          sudo apt-get update
          sudo apt-get install -y google-chrome-stable
        shell: bash

      # Step 7: Start Jekyll server and execute automated test suite
      - name: Start Jekyll Server and Run Tests
        run: |
          sudo apt-get install -y ruby-full build-essential zlib1g-dev curl
          gem install bundler
          bundle config set --local path vendor/bundle
          bundle install

          nohup bundle exec jekyll serve &

          for i in {1..60}; do
            if curl -s http://localhost:4000 > /dev/null; then
              echo "Jekyll server is up!"
              break
            fi
            echo "Waiting for server... ($i)"
            sleep 1
          done

          if ! curl -s http://localhost:4000 > /dev/null; then
            echo "Server failed to start within timeout. Aborting tests."
            exit 1
          fi

          python3 tests/run.py
        shell: bash