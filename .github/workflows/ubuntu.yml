name: TestHarness (Ubuntu)

# Triggered automatically on the last day of each month
# Also supports manual execution via GitHub UI
on:
  schedule:
    # Run on the 31st of months with 31 days (Jan, Mar, May, Jul, Aug, Oct, Dec)
    - cron: '0 0 31 1,3,5,7,8,10,12 *'
    # Run on the 30th of months with 30 days (Apr, Jun, Sep, Nov)
    - cron: '0 0 30 4,6,9,11 *'
    # Run on the 29th of February (leap years)
    - cron: '0 0 29 2 *'
    # Run on the 28th of February (non-leap years)
    - cron: '0 0 28 2 *'
  workflow_dispatch:

jobs:
  build:
    # Restrict execution to develop branch
    if: github.ref == 'refs/heads/develop'
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      # Step 1: Checkout the latest commit from the repository
      - name: Checkout Code
        uses: actions/checkout@v5

      # Step 2: Setup Python 3.13 environment for test execution
      - name: Setup Python
        uses: actions/setup-python@v6
        with:
          python-version: '3.13'

      # Step 3: Install Python dependencies from setups/requirements.txt
      - name: Install Python Dependencies
        run: |
          python3 -m pip install --upgrade pip --quiet
          pip install --disable-pip-version-check --no-cache-dir --quiet -r setups/requirements.txt
        shell: bash

      # Step 4: Setup Oracle Java 21 for JVM-based tooling
      - name: Setup Java
        uses: actions/setup-java@v5
        with:
          distribution: 'oracle'
          java-version: '21'

      # Step 5: Install Rust, FreeGLUT, and NASM
      - name: Install Rust, FreeGLUT, and NASM
        run: |
          sudo apt-get -qq update > /dev/null
          sudo apt-get -qq install -y rustc freeglut3-dev nasm > /dev/null
        shell: bash

      # Step 6: Install Google Chrome browser
      - name: Install Google Chrome
        run: |
          # Add Google's signing key and Chrome repo
          wget -q -O - https://dl.google.com/linux/linux_signing_key.pub | sudo apt-key add -
          sudo sh -c 'echo "deb [arch=amd64] http://dl.google.com/linux/chrome/deb/ stable main" >> /etc/apt/sources.list.d/google-chrome.list'
          sudo apt-get -qq update > /dev/null
          sudo apt-get -qq install -y google-chrome-stable > /dev/null
        shell: bash

      # Step 7: Start Jekyll server and execute automated test suite
      - name: Start Jekyll Server and Run Tests
        run: |
          # Install Ruby and build tools required for native gems
          sudo apt-get -qq install -y ruby-full build-essential zlib1g-dev curl > /dev/null

          # Configure local gem path to avoid sudo
          export GEM_HOME="$HOME/.gem"
          export PATH="$GEM_HOME/bin:$PATH"

          # Install bundler and project gems quietly
          gem install bundler --quiet --no-document > /dev/null
          bundle config set --local path vendor/bundle
          bundle install --quiet > /dev/null

          # Start Jekyll server in background
          nohup bundle exec jekyll serve &

          # Wait for server to become available
          for i in {1..60}; do
            if curl -s http://localhost:4000 > /dev/null; then
              echo "Jekyll server is up!"
              break
            fi
            echo "Waiting for server... ($i)"
            sleep 5
          done

          # Final check before running tests
          if ! curl -s http://localhost:4000 > /dev/null; then
            echo "Server failed to start within timeout. Aborting tests."
            exit 1
          fi

          # Ruby Toolchain Version Report
          echo ""
          echo "Ruby Toolchain Version Report"
          echo "----------------------------------------------------------------------------------------------------"
          echo "Ruby: $(ruby -v)"
          echo "Gem:  $(gem -v)"
          echo "Jekyll: $(bundle exec jekyll -v)"
          echo "Bundler: $(bundler -v)"

          # Execute Python test suite
          python3 tests/run.py
        shell: bash