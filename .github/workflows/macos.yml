name: TestHarness (macOS)

# Triggered automatically on the last day of each month
# Also supports manual execution via GitHub UI
on:
  schedule:
    # Run on the 31st of months with 31 days (Jan, Mar, May, Jul, Aug, Oct, Dec)
    - cron: '0 0 31 1,3,5,7,8,10,12 *'
    # Run on the 30th of months with 30 days (Apr, Jun, Sep, Nov)
    - cron: '0 0 30 4,6,9,11 *'
    # Run on the 29th of February (leap years)
    - cron: '0 0 29 2 *'
    # Run on the 28th of February (non-leap years)
    - cron: '0 0 28 2 *'
  workflow_dispatch:

jobs:
  build:
    # Restrict execution to develop branch
    if: github.ref == 'refs/heads/develop'
    runs-on: macos-latest
    timeout-minutes: 15

    steps:
      # Step 1: Checkout the latest commit from the repository
      - name: Checkout Code
        uses: actions/checkout@v5

      # Step 2: Setup Python 3.13 environment for test execution
      - name: Setup Python
        uses: actions/setup-python@v6
        with:
          python-version: '3.13'

      # Step 3: Install Python dependencies from setups/requirements.txt
      - name: Install Python Dependencies
        run: |
          python3 -m pip install --upgrade pip > /dev/null 2>&1
          pip install --quiet -r setups/requirements.txt > /dev/null 2>&1
        shell: bash

      # Step 4: Setup Oracle Java 21 for JVM-based tooling
      - name: Setup Java
        uses: actions/setup-java@v5
        with:
          distribution: 'oracle'
          java-version: '21'

      # Step 5: Install Rust and NASM (FreeGLUT skipped for macOS unless needed)
      - name: Install Rust and NASM
        run: |
          brew update > /dev/null 2>&1
          brew install rust nasm > /dev/null 2>&1
        shell: bash

      # Step 6: Start Jekyll server and execute automated test suite
      - name: Start Jekyll Server and Run Tests
        run: |
          # Install Ruby and Bundler quietly
          brew install ruby > /dev/null 2>&1
          export GEM_HOME="$HOME/.gem"
          export PATH="$GEM_HOME/bin:$PATH"
          gem install bundler > /dev/null 2>&1
          bundle config set --local path vendor/bundle
          bundle install > /dev/null 2>&1

          # Start Jekyll server in background
          nohup bundle exec jekyll serve > /dev/null 2>&1 &

          # Wait for server to become available (max 60 seconds)
          for i in {1..60}; do
            if curl -s http://localhost:4000 > /dev/null; then
              echo "Jekyll server is up!"
              break
            fi
            echo "Waiting for server... ($i)"
            sleep 5
          done

          if ! curl -s http://localhost:4000 > /dev/null; then
            echo "Server failed to start within timeout. Aborting tests."
            exit 1
          fi

          # Execute Python test suite
          python3 tests/run.py
        shell: bash