{%- if path[1] == "about" and path[2] == nil -%}{%- assign about_section = "about_home_true" -%}
{%- elsif path[1] == "about" and path[2] != nil -%}{%- assign about_section = "about_home_false" -%}{%- endif -%}
<div id="app" class="container {{ about_section }}" style="display: none;">
    <div class="board">
        <div class="boardtitle">Resources</div>
        <a class="card" href="about/faqs">Frequently Asked Questions</a>
        <a class="card" href="about/contribute">Contribution Guide</a>
        <a class="card" href="about/terms">Terms of Use</a>
        <a class="card" href="about/privacy">Privacy Policy</a>
        <a class="card" href="about/disclaimer">Disclaimer</a>
    </div>
    <div class="board">
        <div class="boardtitle">Contribute</div>
        <a class="card" href="{{ site.data.url.teams }}">Join Teams</a>
        <a class="card" href="{{ site.data.url.issues }}">Report Bug</a>
        <a class="card" href="{{ site.data.url.releases }}">Releases</a>
    </div>
    <div class="board">
        <div class="boardtitle">Social Handles</div>
        <a class="card" href="{{ site.data.url.linkedin }}">LinkedIn</a>
        <a class="card" href="{{ site.data.url.github }}">GitHub</a>
        <a class="card" href="{{ site.data.url.discord }}">Discord</a>
    </div>
    <div class="board">
        <div class="boardtitle">App Settings</div>
        <a id="version" class="card disabled"></a>
        <a id="cache" class="card" href="clear:">Clear: Cache and History</a>
        <a id="app-theme-switcher" class="card" style="cursor: pointer;">Theme: System Default</a>
    </div>
</div>

<footer class="isWebView" id="isWebView" style="display: none;">
{% if path[1] == nil %}
    {% assign f_home="wvnav-item-active" %}
{% elsif path[1] == "tools" or path[1] == "calculators" or path[1] == "converters" %}
    {% assign f_tools="wvnav-item-active" %}
{% elsif path[1] == "about" or path[1] == "shubhamrdarda" %}
    {% assign f_about="wvnav-item-active" %}
{% else %}
    {% assign f_learn="wvnav-item-active" %}
{% endif %}
<div class="d-flex justify-content-between wvnav">
    <a class="wvnav-item {{ f_home }}" href="{{ site.url }}"><i class="wvsvg {{ f_home }}- bi {% if f_home == "wvnav-item-active" %}bi-house-heart-fill{% else %}bi-house-heart{% endif %}"></i><div class="text-center">Home</div></a>
    <a class="wvnav-item {{ f_learn }}" href="{{ site.url }}/learn"><i class="wvsvg {{ f_learn }}-{{ path[1] }} bi {% if f_learn == "wvnav-item-active" %}bi-lightbulb-fill{% else %}bi-lightbulb{% endif %}"></i><div class="text-center">Learn</div></a>
    <a id="share-button" class="wvnav-item" href="share:{{ site.url }}{{ page.url }}"><i class="wvsvg bi bi-share"></i><div class="text-center">Share</div></a>
    <a class="wvnav-item {{ f_tools }}" href="{{ site.url }}/tools"><i class="wvsvg {{ f_tools }}-{{ path[1] }} bi {% if f_tools == "wvnav-item-active" %}bi-gear-fill{% else %}bi-gear{% endif %}"></i><div class="text-center">Tools</div></a>
    <a class="wvnav-item {{ f_about }}" href="{{ site.url }}/about"><i class="wvsvg {{ f_about }}-about bi {% if f_about == "wvnav-item-active" %}bi-info-circle-fill{% else %}bi-info-circle{% endif %}"></i><div class="text-center">About</div></a>
</div>
</footer>

<script>
async function showVersion() {
    const versionElement = document.getElementById("version");
    if (!versionElement) return;

    const CACHE_KEY = "gd_app_version";
    const now = new Date();
    const year = now.getFullYear().toString().slice(-2);
    const fallbackVersion = `App Version: v${year}`;
    let cached = null;

    try {
        const stored = localStorage.getItem(CACHE_KEY);
        if (stored) {
            cached = JSON.parse(stored);
            versionElement.textContent = cached.value;
        }
    } catch (e) {
        console.error("Error reading version from localStorage:", e);
    }

    // Only check monthly if we have a valid, actual version cached (i.e., contains a dot).
    // Otherwise, fetch on every load until a valid version is retrieved.
    if (cached && cached.value.includes('.')) {
        const lastFetch = new Date(cached.timestamp);
        const isNewMonth = (now.getFullYear() > lastFetch.getFullYear()) ||
                           (now.getFullYear() === lastFetch.getFullYear() && now.getMonth() > lastFetch.getMonth());
        if (!isNewMonth) {
            return; // We have a valid, recent version. No need to fetch.
        }
    }

    try {
        const response = await fetch(`https://api.github.com/repos/godarda/godarda.github.io/commits?per_page=10`, { cache: "no-store" });
        if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
        const commits = await response.json();
        const regex = /^v\d{2}\.\d{1,2}/;
        let versionCommit = null;

        for (const commit of commits) {
            const firstLine = commit.commit.message.split("\n")[0].trim();
            const match = firstLine.match(regex);
            if (match) { versionCommit = match[0]; break; }
        }
        if (versionCommit) {
            const result = `App Version: ${versionCommit}`;
            versionElement.textContent = result;
            localStorage.setItem(CACHE_KEY, JSON.stringify({ value: result, timestamp: now.getTime() }));
        } else if (!cached) {
            versionElement.textContent = fallbackVersion;
        }
    } catch (error) {
        console.error("Error fetching commits:", error);
        if (!cached) {
            versionElement.textContent = fallbackVersion;
        }
    }
}

function setupAppView() {
    document.body.classList.add('is-webview');
    document.getElementById("isWebView").style.display = "block";
    document.getElementById("backtotop").style.marginBottom = "100px";

    document.onselectstart = (e) => e.preventDefault();
    $('body').on('contextmenu', () => false);

    const aboutSection = document.getElementById("app");
    if (aboutSection && aboutSection.classList.contains("about_home_true")) {
        aboutSection.style.display = "block";
        document.getElementById("navbar-brand").style.marginLeft = "0px";
        document.getElementById("lsidebar").style.display = "none";
        document.getElementById("leftsidebar").style.display = "none";
    } else if (aboutSection && aboutSection.classList.contains("about_home_false")) {
        document.getElementById("navbar-brand").style.marginLeft = "0px";
        document.getElementById("lsidebar").style.display = "none";
    }

    const shareButton = document.getElementById("share-button");
    if (shareButton) {
        let isClickDisabled = false;
        shareButton.addEventListener('click', (event) => {
            if (isClickDisabled) { event.preventDefault(); } 
            else { isClickDisabled = true; setTimeout(() => { isClickDisabled = false; }, 400); }
        });
        shareButton.addEventListener('dblclick', (event) => { event.preventDefault(); });
    }

    document.documentElement.addEventListener('dblclick', (event) => {
        if (event.target.closest('a, button, .navbar, .wvnav')) { return; }
        window.location.href = "share:{{ site.url }}{{ page.url }}";
    });

    $("#cache").click(function () {
        $(this).html("Cleared: Cache and History");
        $(this).css("color", "#00b050");
    });

    showVersion();
}

window.addEventListener('DOMContentLoaded', () => { if (window.isGoDardaApp) setupAppView(); });
</script>